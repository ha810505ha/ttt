// js/ui.js
// ÈÄôÂÄãÊ™îÊ°àË≤†Ë≤¨Ê∏≤ÊüìÊâÄÊúâ‰ΩøÁî®ËÄÖ‰ªãÈù¢ÂÖÉ‰ª∂„ÄÇ

import * as DOM from './dom.js';
import { state, tempState } from './state.js';
import { DEFAULT_AVATAR, MODELS } from './constants.js';
import { getActivePromptSet } from './promptManager.js';
import { getActiveLorebook } from './lorebookManager.js';

/**
 * @description Â•óÁî®ÊâÄÊúâÂ∑≤ÂïüÁî®ÁöÑÊ≠£Ë¶èË°®ÈÅîÂºèË¶èÂâá
 * @param {string} text - AI ÂõûÊáâÁöÑÂéüÂßãÊñáÂ≠ó
 * @returns {string} - Á∂ìÈÅéË¶èÂâáËôïÁêÜÂæåÁöÑÊñáÂ≠ó
 */
function applyRegexRules(text) {
    const regexRules = state.globalSettings.regexRules || [];
    const enabledRules = regexRules.filter(rule => rule.enabled);
    let processedText = text;

    for (const rule of enabledRules) {
        try {
            const regex = new RegExp(rule.find, 'gsi');
            processedText = processedText.replace(regex, rule.replace);
        } catch (e) {
            console.warn(`ÁÑ°ÊïàÁöÑÊ≠£Ë¶èË°®ÈÅîÂºèË¶èÂâá [${rule.name}]ÔºåÂ∑≤Ë∑≥ÈÅé:`, e);
        }
    }
    return processedText;
}

/**
 * @description Ê∏≤Êüì„ÄåÂ∏≥Ëôü„ÄçÂàÜÈ†ÅÁöÑÂÖßÂÆπ
 */
export function renderAccountTab() {
    if (state.currentUser) {
        DOM.loginPrompt.classList.add('hidden');
        DOM.userInfoDetails.classList.remove('hidden');
        DOM.userAvatarInSettings.src = state.currentUser.photoURL || DEFAULT_AVATAR;
        DOM.userNameInSettings.textContent = state.currentUser.displayName || '‰ΩøÁî®ËÄÖ';
    } else {
        DOM.loginPrompt.classList.remove('hidden');
        DOM.userInfoDetails.classList.add('hidden');
    }
}


/**
 * @description Ê∏≤ÊüìËßíËâ≤ÂàóË°®
 */
export function renderCharacterList() {
    DOM.characterList.innerHTML = '';

    const sortedCharacters = [...state.characters].sort((a, b) => {
        if (a.loved !== b.loved) {
            return a.loved ? -1 : 1;
        }
        return (a.order || 0) - (b.order || 0);
    });

    sortedCharacters.forEach(char => {
        const item = document.createElement('li');
        item.className = `character-item ${char.loved ? 'loved' : ''}`;
        item.dataset.id = char.id;
        item.innerHTML = `
            <div class="char-item-content">
                <i class="fa-solid fa-grip-vertical drag-handle"></i>
                <img src="${char.avatarUrl || DEFAULT_AVATAR}" alt="${char.name}" class="char-item-avatar">
                <div class="character-item-details">
                    <span class="char-item-name">${char.name}</span>
                    ${char.creator ? `<span class="character-item-author">By: ${char.creator}</span>` : ''}
                </div>
            </div>
        `;
        DOM.characterList.appendChild(item);
    });
}

/**
 * @description È°ØÁ§∫ËßíËâ≤ÂàóË°®Ë¶ñÂúñ(‰∏¶Èö±ËóèÂÅ¥ÈÇäÊ¨Ñ)
 */
export function showCharacterListView() {
    DOM.leftPanel.classList.remove('show-chats');
    DOM.leftPanel.classList.remove('mobile-visible');
    DOM.mobileOverlay.classList.add('hidden');
    state.activeCharacterId = null;
}

/**
 * @description Â∞áÂÅ¥ÈÇäÊ¨ÑÂÖßÂÆπÂàáÊèõÂõûËßíËâ≤ÂàóË°®Ôºå‰ΩÜ‰∏çÈö±ËóèÂÅ¥ÈÇäÊ¨Ñ
 */
export function switchPanelToCharacterView() {
    DOM.leftPanel.classList.remove('show-chats');
    state.activeCharacterId = null;
}

/**
 * @description È°ØÁ§∫ÊåáÂÆöËßíËâ≤ÁöÑËÅäÂ§©ÂÆ§ÂàóË°®Ë¶ñÂúñÔºå‰∏¶Êõ¥Êñ∞Ê®ôÈ†≠ÁöÑÊÑõÂøÉÁãÄÊÖã
 * @param {string} charId - ËßíËâ≤ ID
 */
export function showChatSessionListView(charId) {
    try {
        state.activeCharacterId = charId;
        const character = state.characters.find(c => c.id === charId);
        if (!character) {
            console.error("Êâæ‰∏çÂà∞ËßíËâ≤:", charId);
            return;
        }
        
        DOM.leftPanel.classList.add('show-chats');

        const headerNameContainer = DOM.chatListHeaderName.parentElement;
        headerNameContainer.querySelector('h2').textContent = character.name;

        const heartIcon = DOM.headerLoveChatBtn.querySelector('i');
        DOM.headerLoveChatBtn.classList.toggle('loved', character.loved);
        heartIcon.className = `fa-${character.loved ? 'solid' : 'regular'} fa-heart`;

        renderChatSessionList();
    } catch (error) {
        console.error("È°ØÁ§∫ËÅäÂ§©ÂÆ§ÂàóË°®ÊôÇÁôºÁîüÈåØË™§:", error);
        alert("ËºâÂÖ•ËÅäÂ§©ÂÆ§ÂàóË°®ÊôÇÁôºÁîüÈåØË™§ÔºåË´ãÊ™¢Êü•‰∏ªÊéßÂè∞„ÄÇ");
        DOM.leftPanel.classList.remove('show-chats');
    }
}

/**
 * @description Ê∏≤ÊüìÊåáÂÆöËßíËâ≤ÁöÑËÅäÂ§©ÂÆ§ÂàóË°®
 */
export function renderChatSessionList() {
    DOM.chatSessionList.innerHTML = '';
    const sessions = state.chatHistories[state.activeCharacterId] || {};
    const metadatas = state.chatMetadatas[state.activeCharacterId] || {};
    
    const sortedSessions = Object.keys(sessions)
        .map(chatId => ({
            id: chatId,
            ...metadatas[chatId],
            lastMessage: sessions[chatId]?.slice(-1)[0]
        }))
        .sort((a, b) => {
            if (a.pinned !== b.pinned) return a.pinned ? -1 : 1;
            return (a.order || 0) - (b.order || 0);
        });

    if (sortedSessions.length === 0) {
        DOM.chatSessionList.innerHTML = `<li class="list-placeholder">Â∞öÁÑ°Â∞çË©±</li>`;
        return;
    }

    sortedSessions.forEach(session => {
        const lastMsgContent = session.lastMessage 
            ? (Array.isArray(session.lastMessage.content) ? session.lastMessage.content[session.lastMessage.activeContentIndex] : session.lastMessage.content).substring(0, 25) + '...'
            : 'Êñ∞Â∞çË©±';
        const displayName = (session.pinned ? 'üìå ' : '') + (session.name || lastMsgContent);
        
        const item = document.createElement('li');
        item.className = `chat-session-item ${session.id === state.activeChatId ? 'active' : ''}`;
        item.dataset.id = session.id;
        item.innerHTML = `
            <div class="session-item-content">
                 <i class="fa-solid fa-grip-vertical drag-handle"></i>
                <span class="session-item-name">${displayName}</span>
            </div>
            <div class="session-item-actions">
                <button class="icon-btn-sm pin-chat-btn ${session.pinned ? 'active' : ''}" title="ÁΩÆÈ†Ç"><i class="fa-solid fa-thumbtack"></i></button>
                <button class="icon-btn-sm rename-chat-btn" title="ÈáçÊñ∞ÂëΩÂêç"><i class="fa-solid fa-i-cursor"></i></button>
            </div>
        `;
        DOM.chatSessionList.appendChild(item);
    });
}

/**
 * @description Ê∏≤ÊüìÁï∂ÂâçÊ¥ªË∫çÁöÑËÅäÂ§©‰ªãÈù¢
 */
export function renderActiveChat() {
    if (!state.activeCharacterId || !state.activeChatId) {
        DOM.welcomeScreen.classList.remove('hidden');
        DOM.chatInterface.classList.add('hidden');
        return;
    }
    DOM.welcomeScreen.classList.add('hidden');
    DOM.chatInterface.classList.remove('hidden');
    
    const activeChar = state.characters.find(c => c.id === state.activeCharacterId);
    if (!activeChar) return;
    
    const metadata = state.chatMetadatas[state.activeCharacterId]?.[state.activeChatId] || {};

    DOM.chatHeaderAvatar.src = activeChar.avatarUrl || DEFAULT_AVATAR;
    DOM.chatHeaderName.textContent = activeChar.name;
    DOM.chatNotesInput.value = metadata.notes || '';
    
    const provider = state.globalSettings.apiProvider || 'official_gemini';
    const modelId = state.globalSettings.apiModel;
    let modelDisplayName = modelId || 'Êú™Ë®≠ÂÆö';

    if (modelId && MODELS[provider]) {
        const modelObject = MODELS[provider].find(m => m.value === modelId);
        if (modelObject) {
            modelDisplayName = modelObject.name;
        }
    }
    
    DOM.chatHeaderModelName.textContent = modelDisplayName;
    DOM.chatHeaderModelName.title = modelDisplayName;
    
    renderChatUserPersonaSelector();
    renderChatMessages();
}

/**
 * @description Ê∏≤ÊüìÁï∂ÂâçÂ∞çË©±ÁöÑÊâÄÊúâË®äÊÅØ
 */
export function renderChatMessages() {
    DOM.chatWindow.innerHTML = '';
    const history = state.chatHistories[state.activeCharacterId]?.[state.activeChatId] || [];
    history.forEach((msg, index) => {
        const contentToDisplay = (msg.role === 'assistant' && Array.isArray(msg.content)) 
            ? msg.content[msg.activeContentIndex] 
            : msg.content;
        displayMessage(contentToDisplay, msg.role, msg.timestamp, index, false, msg.error);
    });
    DOM.chatWindow.scrollTop = DOM.chatWindow.scrollHeight;
}

/**
 * @description Âú®ËÅäÂ§©Ë¶ñÁ™ó‰∏≠È°ØÁ§∫ÂñÆÂâáË®äÊÅØÔºå‰∏¶Âú®È°ØÁ§∫ÂâçÂ•óÁî®Ê≠£Ë¶èË°®ÈÅîÂºè
 * @param {string} text - Ë®äÊÅØÂÖßÂÆπ
 * @param {string} sender - 'user' Êàñ 'assistant'
 * @param {string} timestamp - ISO Ê†ºÂºèÁöÑÊôÇÈñìÊà≥
 * @param {number} index - Ë®äÊÅØÂú®Ê≠∑Âè≤Á¥ÄÈåÑ‰∏≠ÁöÑÁ¥¢Âºï
 * @param {boolean} isNew - ÊòØÂê¶ÁÇ∫ÂâõÊî∂Âà∞ÁöÑÊñ∞Ë®äÊÅØ
 * @param {string|null} error - ÈåØË™§Ë®äÊÅØ
 * @returns {HTMLElement} - Âª∫Á´ãÁöÑË®äÊÅØ DOM ÂÖÉÁ¥†
 */
export function displayMessage(text, sender, timestamp, index, isNew, error = null) {
    const metadata = state.chatMetadatas[state.activeCharacterId]?.[state.activeChatId] || {};
    const currentPersonaId = metadata.userPersonaId || state.activeUserPersonaId;
    const userPersona = state.userPersonas.find(p => p.id === currentPersonaId) || state.userPersonas[0];
    const userAvatar = userPersona?.avatarUrl || DEFAULT_AVATAR;

    const activeChar = state.characters.find(c => c.id === state.activeCharacterId);
    const charAvatar = activeChar?.avatarUrl || DEFAULT_AVATAR;
    const avatarUrl = sender === 'user' ? userAvatar : charAvatar;
    
    const row = document.createElement('div');
    row.className = `message-row ${sender === 'user' ? 'user-row' : 'assistant-row'} ${error ? 'has-error' : ''}`;
    row.dataset.index = index;

    if (tempState.isScreenshotMode && tempState.selectedMessageIndices.includes(index)) {
        row.classList.add('selected');
    }
    
    const formattedTimestamp = new Date(timestamp).toLocaleString('zh-TW', { hour12: false, year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' });

    let messageActionsHTML = '';
    const msgData = state.chatHistories[state.activeCharacterId]?.[state.activeChatId]?.[index];

    if (sender === 'assistant' && msgData) {
        if (msgData.content.length > 1) {
            messageActionsHTML += `
                <div class="version-nav">
                    <button class="version-prev-btn" ${msgData.activeContentIndex === 0 ? 'disabled' : ''}><i class="fa-solid fa-chevron-left"></i></button>
                    <span class="version-counter">${msgData.activeContentIndex + 1}/${msgData.content.length}</span>
                    <button class="version-next-btn" ${msgData.activeContentIndex === msgData.content.length - 1 ? 'disabled' : ''}><i class="fa-solid fa-chevron-right"></i></button>
                </div>`;
        }
        const history = state.chatHistories[state.activeCharacterId]?.[state.activeChatId] || [];
        if (index === history.length - 1) {
             messageActionsHTML += `<button class="regenerate-btn-sm" title="ÂÜçÁîüÊàê‰∏ÄÂâáÊñ∞ÁöÑÂõûÊáâÔºü"><i class="fa-solid fa-arrows-rotate"></i> ÂÜçÁîüÊàê</button>`;
        }
    }

    row.innerHTML = `
        <img src="${avatarUrl}" alt="${sender} avatar" class="chat-avatar">
        <div class="bubble-container">
            <div class="chat-bubble"></div>
            ${error ? `<div class="message-error"><span>${error}</span><button class="retry-btn-sm"><i class="fa-solid fa-rotate-right"></i> ÈáçË©¶</button></div>` : ''}
            <div class="message-timestamp">${formattedTimestamp}</div>
            <div class="message-actions" style="${messageActionsHTML ? 'display: flex;' : 'display: none;'}">${messageActionsHTML}</div>
        </div>
        <button class="icon-btn edit-msg-btn" title="Á∑®ËºØË®äÊÅØ"><i class="fa-solid fa-pencil"></i></button>
    `;
    
    let contentToRender = text;
    if (sender === 'assistant') {
        contentToRender = applyRegexRules(text);
    }

    contentToRender = (contentToRender || '').replace(/(„Äå[^„Äç]*„Äç|„Äé[^„Äè]*„Äè)/g, '<span class="quoted-text">$1</span>');
    const bubble = row.querySelector('.chat-bubble');
    bubble.innerHTML = marked.parse(contentToRender || '');

    DOM.chatWindow.appendChild(row);
    if (isNew) {
        DOM.chatWindow.scrollTop = DOM.chatWindow.scrollHeight;
    }
    return row;
}

/**
 * @description Â∞á state ‰∏≠ÁöÑÂÖ®ÂüüË®≠ÂÆöËºâÂÖ•Âà∞ UI ‰∏≠
 */
export function loadGlobalSettingsToUI() {
    // ‰øùÂ≠òÁï∂ÂâçÊ¥ªË∫çÁãÄÊÖã
    const savedActiveCharacterId = state.activeCharacterId;
    const savedActiveChatId = state.activeChatId;

    renderAccountTab();

    const settings = state.globalSettings;

    const officialGeminiOption = DOM.apiProviderSelect.querySelector('option[value="official_gemini"]');
    if (officialGeminiOption) {
        officialGeminiOption.hidden = !state.isPremiumUser;
    }

    DOM.apiProviderSelect.value = settings.apiProvider || 'openai';
    updateModelDropdown(); 
    DOM.apiModelSelect.value = settings.apiModel || (MODELS[DOM.apiProviderSelect.value] ? MODELS[DOM.apiProviderSelect.value][0].value : '');
    DOM.apiKeyInput.value = settings.apiKey || '';
    DOM.temperatureSlider.value = settings.temperature || 1;
    DOM.temperatureValue.value = settings.temperature || 1;
    DOM.topPSlider.value = settings.topP || 1;
    DOM.topPValue.value = settings.topP || 1;
    DOM.repetitionPenaltySlider.value = settings.repetitionPenalty || 0;
    DOM.repetitionPenaltyValue.value = settings.repetitionPenalty || 0;
    DOM.contextSizeInput.value = settings.contextSize || 30000;
    DOM.maxTokensSlider.value = settings.maxTokens || 1024;
    DOM.maxTokensValue.value = settings.maxTokens || 1024;
    
    DOM.themeSelect.value = settings.theme || 'light';
    DOM.summarizationPromptInput.value = settings.summarizationPrompt || '';

    renderUserPersonaList();
    renderActiveUserPersonaSelector();
    renderApiPresetsDropdown();
    renderPromptSetSelector();
    renderPromptList();
    renderLorebookSelector();
    renderLorebookEntryList();
    renderRegexRulesList();

    // ÊÅ¢Âæ©Ê¥ªË∫çÁãÄÊÖã
    state.activeCharacterId = savedActiveCharacterId;
    state.activeChatId = savedActiveChatId;

    DOM.settingsTabsContainer.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
    DOM.globalSettingsModal.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
    DOM.settingsTabsContainer.querySelector('[data-tab="account-tab"]').classList.add('active');
    DOM.accountTab.classList.add('active');
}
/**
 * @description Ê†πÊìö API ‰æõÊáâÂïÜÊõ¥Êñ∞Ê®°Âûã‰∏ãÊãâÈÅ∏ÂñÆ
 */
export function updateModelDropdown() {
    const provider = DOM.apiProviderSelect.value;
    const models = MODELS[provider] || [];
    DOM.apiModelSelect.innerHTML = ''; 
    models.forEach(model => {
        const option = document.createElement('option');
        option.value = model.value;
        option.textContent = model.name;
        DOM.apiModelSelect.appendChild(option);
    });
    const savedModel = state.globalSettings.apiModel;
    if (savedModel && models.some(m => m.value === savedModel)) {
        DOM.apiModelSelect.value = savedModel;
    } else if (models.length > 0) {
        DOM.apiModelSelect.value = models[0].value;
    }

    if (DOM.apiProviderSelect.options[DOM.apiProviderSelect.selectedIndex].hidden) {
        DOM.apiProviderSelect.value = 'openai';
    }

    DOM.apiKeyFormGroup.classList.toggle('hidden', provider === 'official_gemini');
}

/**
 * @description Ê∏≤Êüì‰ΩøÁî®ËÄÖËßíËâ≤ÂàóË°® (Âú®Ë®≠ÂÆö‰∏≠)
 */
export function renderUserPersonaList() {
    DOM.userPersonaList.innerHTML = '';
    state.userPersonas.forEach(persona => {
        const item = document.createElement('li');
        item.className = 'persona-item';
        item.dataset.id = persona.id;
        item.innerHTML = `
            <img src="${persona.avatarUrl || DEFAULT_AVATAR}" alt="${persona.name}" class="persona-item-avatar">
            <span class="persona-item-name">${persona.name}</span>
            <div class="persona-item-actions">
                <button class="icon-btn-sm edit-persona-btn" title="Á∑®ËºØ"><i class="fa-solid fa-pencil"></i></button>
                <button class="icon-btn-sm delete-persona-btn" title="Âà™Èô§"><i class="fa-solid fa-trash"></i></button>
            </div>
        `;
        DOM.userPersonaList.appendChild(item);
    });
}

/**
 * @description Ê∏≤ÊüìÈ†êË®≠‰ΩøÁî®ËÄÖËßíËâ≤ÁöÑ‰∏ãÊãâÈÅ∏ÂñÆ
 */
export function renderActiveUserPersonaSelector() {
    DOM.activeUserPersonaSelect.innerHTML = '';
    state.userPersonas.forEach(persona => {
        const option = document.createElement('option');
        option.value = persona.id;
        option.textContent = persona.name;
        DOM.activeUserPersonaSelect.appendChild(option);
    });
    DOM.activeUserPersonaSelect.value = state.activeUserPersonaId;
}

/**
 * @description Ê∏≤ÊüìËÅäÂ§©‰ªãÈù¢‰∏≠ÁöÑ‰ΩøÁî®ËÄÖËßíËâ≤‰∏ãÊãâÈÅ∏ÂñÆ
 */
export function renderChatUserPersonaSelector() {
    DOM.chatUserPersonaSelect.innerHTML = '';
    state.userPersonas.forEach(persona => {
        const option = document.createElement('option');
        option.value = persona.id;
        option.textContent = persona.name;
        DOM.chatUserPersonaSelect.appendChild(option);
    });
    const metadata = state.chatMetadatas[state.activeCharacterId]?.[state.activeChatId] || {};
    DOM.chatUserPersonaSelect.value = metadata.userPersonaId || state.activeUserPersonaId;
}

/**
 * @description Ê∏≤Êüì API Ë®≠ÂÆöÊ™î‰∏ãÊãâÈÅ∏ÂñÆ
 */
export function renderApiPresetsDropdown() {
    DOM.apiPresetSelect.innerHTML = '<option value="">ÈÅ∏ÊìáË¶ÅËºâÂÖ•ÁöÑË®≠ÂÆöÊ™î...</option>';
    state.apiPresets.forEach(preset => {
        const option = document.createElement('option');
        option.value = preset.id;
        option.textContent = preset.name;
        DOM.apiPresetSelect.appendChild(option);
    });
}

/**
 * @description Â∞áÈÅ∏ÊìáÁöÑ API Ë®≠ÂÆöÊ™îËºâÂÖ•Âà∞ UI
 * @param {string} presetId - Ë®≠ÂÆöÊ™î ID
 */
export async function loadApiPresetToUI(presetId) {
    const preset = state.apiPresets.find(p => p.id === presetId);
    if (!preset) return;

    DOM.apiProviderSelect.value = preset.provider;
    
    updateModelDropdown();
    await new Promise(resolve => setTimeout(resolve, 0));
    
    DOM.apiModelSelect.value = preset.model;
    DOM.apiKeyInput.value = preset.apiKey;
    DOM.apiStatusIndicator.style.display = 'none';
}

/**
 * @description ÈñãÈóú Modal
 * @param {string} modalId - Modal ÁöÑ ID
 * @param {boolean} show - true ÁÇ∫È°ØÁ§∫, false ÁÇ∫Èö±Ëóè
 */
export function toggleModal(modalId, show) {
    document.getElementById(modalId).classList.toggle('hidden', !show);
}

/**
 * @description Ë®≠ÂÆö AI ÊòØÂê¶Ê≠£Âú®ÁîüÊàê‰∏≠ÁöÑÁãÄÊÖã
 * @param {boolean} isGenerating - ÊòØÂê¶Ê≠£Âú®ÁîüÊàê
 * @param {boolean} [changeMainButton=true] - ÊòØÂê¶ÊîπËÆä‰∏ªÈÄÅÂá∫ÊåâÈàïÁöÑÁãÄÊÖã
 */
export function setGeneratingState(isGenerating, changeMainButton = true) {
    if (changeMainButton) {
        DOM.sendBtn.classList.toggle('is-generating', isGenerating);
        DOM.sendIcon.classList.toggle('hidden', isGenerating);
        DOM.stopIcon.classList.toggle('hidden', !isGenerating);
        DOM.messageInput.disabled = isGenerating;
    }
    
    document.querySelectorAll('.regenerate-btn-sm, .retry-btn-sm').forEach(btn => {
        btn.disabled = isGenerating;
    });
}

/**
 * @description Ê∏≤ÊüìËßíËâ≤Á∑®ËºØÂô®‰∏≠ÁöÑ„ÄåÁ¨¨‰∏ÄÂè•Ë©±„ÄçËº∏ÂÖ•Ê°Ü
 * @param {Array<string>} [messages=['']] - ÈñãÂ†¥ÁôΩË®äÊÅØÈô£Âàó
 */
export function renderFirstMessageInputs(messages = ['']) {
    DOM.firstMessageList.innerHTML = '';
    const messagesToRender = messages.length > 0 ? messages : [''];
    
    messagesToRender.forEach((msg, index) => {
        const item = document.createElement('div');
        item.className = 'first-message-item';
        item.innerHTML = `
            <textarea class="char-first-message" placeholder="ÈñãÂ†¥ÁôΩ #${index + 1}" rows="1">${msg}</textarea>
            <button type="button" class="icon-btn-sm danger remove-first-message-btn" title="ÁßªÈô§Ê≠§ÈñãÂ†¥ÁôΩ">
                <i class="fa-solid fa-trash"></i>
            </button>
        `;
        DOM.firstMessageList.appendChild(item);
        const textarea = item.querySelector('textarea');
        textarea.addEventListener('input', () => {
            textarea.style.height = 'auto';
            textarea.style.height = `${textarea.scrollHeight}px`;
        });
        setTimeout(() => {
             textarea.style.height = 'auto';
             textarea.style.height = `${textarea.scrollHeight}px`;
        }, 0);
    });
}

/**
 * @description Ê∏≤ÊüìÊèêÁ§∫Ë©ûÂ∫´‰∏ãÊãâÈÅ∏ÂñÆ
 */
export function renderPromptSetSelector() {
    DOM.promptSetSelect.innerHTML = '';
    state.promptSets.forEach(set => {
        const option = document.createElement('option');
        option.value = set.id;
        option.textContent = set.name;
        DOM.promptSetSelect.appendChild(option);
    });
    if (state.activePromptSetId) {
        DOM.promptSetSelect.value = state.activePromptSetId;
    }
}

/**
 * @description Ê∏≤ÊüìÊèêÁ§∫Ë©ûÂàóË°®
 */
export function renderPromptList() {
    const activeSet = getActivePromptSet();
    DOM.promptList.innerHTML = '';

    if (!activeSet || !activeSet.prompts) {
        DOM.promptList.innerHTML = '<li class="list-placeholder">Ê≠§Ë®≠ÂÆöÊ™îÊ≤íÊúâÂèØÁî®ÁöÑÊèêÁ§∫Ë©û„ÄÇ</li>';
        return;
    }

    activeSet.prompts.forEach(prompt => {
        const item = document.createElement('li');
        item.className = 'prompt-item';
        item.dataset.identifier = prompt.identifier;
        item.innerHTML = `
            <i class="fa-solid fa-grip-vertical drag-handle"></i>
            <span class="prompt-item-name" title="${prompt.name}">${prompt.name}</span>
            <div class="prompt-item-actions">
                <button class="icon-btn-sm edit-prompt-btn" title="Á∑®ËºØÊèêÁ§∫Ë©û"><i class="fa-solid fa-pencil"></i></button>
                <div class="prompt-item-toggle ${prompt.enabled ? 'enabled' : ''}"></div>
            </div>
        `;
        DOM.promptList.appendChild(item);
    });
}

/**
 * @description Ê∏≤Êüì‰∏ñÁïåÊõ∏‰∏ãÊãâÈÅ∏ÂñÆ
 */
export function renderLorebookSelector() {
    DOM.lorebookSelect.innerHTML = '';
    state.lorebooks.forEach(book => {
        const option = document.createElement('option');
        option.value = book.id;
        option.textContent = book.name;
        DOM.lorebookSelect.appendChild(option);
    });
    if (state.activeLorebookId) {
        DOM.lorebookSelect.value = state.activeLorebookId;
    } else if (state.lorebooks.length > 0) {
        DOM.lorebookSelect.value = state.lorebooks[0].id;
    }
}

/**
 * @description Ê∏≤Êüì‰∏ñÁïåÊõ∏Ê¢ùÁõÆÂàóË°®
 */
export function renderLorebookEntryList() {
    const activeBook = getActiveLorebook();
    DOM.lorebookEntryList.innerHTML = '';

    if (!activeBook || !activeBook.entries || activeBook.entries.length === 0) {
        DOM.lorebookEntryList.innerHTML = '<li class="list-placeholder">Ê≠§‰∏ñÁïåÊõ∏Ê≤íÊúâÊ¢ùÁõÆ„ÄÇ</li>';
        return;
    }

    activeBook.entries.forEach(entry => {
        const item = document.createElement('li');
        item.className = 'prompt-item'; // ÈáçÁî® prompt-item Ê®£Âºè
        item.dataset.id = entry.id;
        item.innerHTML = `
            <span class="prompt-item-name" title="${entry.name}">${entry.name}</span>
            <div class="prompt-item-actions">
                <button class="icon-btn-sm edit-lorebook-entry-btn" title="Á∑®ËºØÊ¢ùÁõÆ"><i class="fa-solid fa-pencil"></i></button>
                <div class="prompt-item-toggle ${entry.enabled ? 'enabled' : ''}"></div>
            </div>
        `;
        DOM.lorebookEntryList.appendChild(item);
    });
}


/**
 * @description Ê∏≤ÊüìÊ≠£Ë¶èË°®ÈÅîÂºèË¶èÂâáÂàóË°® (Êë∫ÁñäÂºè)
 */
export function renderRegexRulesList() {
    DOM.regexRulesList.innerHTML = '';
    const rules = state.globalSettings.regexRules || [];
    if (rules.length === 0) {
        DOM.regexRulesList.innerHTML = '<li class="list-placeholder">Â∞öÁÑ°Ë¶èÂâá</li>';
        return;
    }

    rules.forEach(rule => {
        const item = document.createElement('li');
        item.className = 'regex-rule-item';
        item.dataset.id = rule.id;
        item.innerHTML = `
            <div class="regex-rule-header">
                <button class="icon-btn-sm regex-expand-btn"><i class="fa-solid fa-chevron-down"></i></button>
                <input type="text" class="regex-name-input" placeholder="Ë¶èÂâáÂêçÁ®±" value="${rule.name}">
                <div class="prompt-item-toggle ${rule.enabled ? 'enabled' : ''}" title="ÂïüÁî®/ÂÅúÁî®Ê≠§Ë¶èÂâá"></div>
                <button class="icon-btn-sm danger delete-regex-rule-btn" title="Âà™Èô§Ê≠§Ë¶èÂâá"><i class="fa-solid fa-trash"></i></button>
            </div>
            <div class="regex-rule-details">
                <div class="form-group">
                    <label>Â∞ãÊâæ (Ê≠£Ë¶èË°®ÈÅîÂºè)</label>
                    <textarea class="regex-find-input" rows="2">${rule.find}</textarea>
                </div>
                <div class="form-group">
                    <label>Âèñ‰ª£ÁÇ∫</label>
                    <textarea class="regex-replace-input" rows="2">${rule.replace}</textarea>
                </div>
            </div>
        `;
        DOM.regexRulesList.appendChild(item);
    });
}

